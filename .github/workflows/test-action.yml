name: Test OCI Registry Cleanup Action

on:
  workflow_dispatch:
    inputs:
      registry-url:
        description: 'Registry URL'
        required: true
        default: 'ghcr.io/test'
        type: string
      registry-username:
        description: 'Registry username'
        required: true
        default: '<username>'
        type: string
      registry-password:
        description: 'Registry password'
        required: true
        default: '<password>'
        type: string
      artifact-filter:
        description: 'Artifact filter regex'
        required: false
        default: 'all'
        type: string
      tag-filter:
        description: 'Tag filter regex'
        required: false
        default: 'all'
        type: string
      dry-run:
        description: 'Dry run mode'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      retention-days:
        description: 'Retention period in days'
        required: false
        default: '30'
        type: string

jobs:
  test-action:
    runs-on: ubuntu-latest
    name: Test Cleanup Action

    steps:
      - name: Run OCI Registry Cleanup
        id: cleanup
        uses: david-monichi/oci-registry-cleanup
        with:
          registry-url: ${{ github.event.inputs.registry-url }}
          registry-username: ${{ github.event.inputs.registry-username }}
          registry-password: ${{ github.event.inputs.registry-password }}
          artifact-filter: ${{ github.event.inputs.artifact-filter }}
          tag-filter: ${{ github.event.inputs.tag-filter }}
          retention-days: ${{ github.event.inputs.retention-days }}
          dry-run: ${{ github.event.inputs.dry-run }}
          log-level: 'DEBUG'
      
      - name: Display results
        if: always()
        run: |
          echo "### Cleanup Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repositories Processed:** ${{ steps.cleanup.outputs.repositories-processed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts Scanned:** ${{ steps.cleanup.outputs.artifacts-scanned }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts Deleted:** ${{ steps.cleanup.outputs.artifacts-deleted }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts Skipped:** ${{ steps.cleanup.outputs.artifacts-skipped }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Errors Encountered:** ${{ steps.cleanup.outputs.errors-encountered }}" >> $GITHUB_STEP_SUMMARY
